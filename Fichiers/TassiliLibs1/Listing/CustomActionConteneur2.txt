<template>
    <div>

          <div>
            <WizardStep/>
          </div>

          <form @submit.prevent="submit('save')">
          <div class="conteneurForm">
          <template
             v-for="([key, field], index) in Object.entries(tassiliInput.form[tassililisting.urlCustomValidation])
             .filter(([k, f]) =>
              f.type !== 'Hidden' &&
            (tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizard']['wizardForm'][tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizardCurrent']] ?? []).includes(k)
               )" :key="key">

             <InputText v-if="field.type === 'Text'"
             :FormKey="tassililisting.urlCustomValidation" :cle="key" />

          <Textarea v-if="field.type === 'Textarea'"
         :FormKey="tassililisting.urlCustomValidation" :cle="key" />

        <InputNumber v-if="field.type === 'Number'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />

       <Password v-if="field.type === 'Password'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />

       <InputSelect v-if="field.type === 'Select'" 
       :cle="key" />

       <InputDate v-if="field.type === 'Date'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />

       <InputRadio v-if="field.type === 'Radio'"
       :cle="key" />

       <Checkbox v-if="field.type === 'Checkbox'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />

       <CheckboxList v-if="field.type === 'CheckboxList'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />

       <RichEditor v-if="field.type === 'Quill'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />

       <InputFileEdit v-if="field.type === 'File'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />
      
       <Repeteur v-if="field.type === 'Repeater'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />

       <MultipleFileEdit v-if="field.type === 'MultipleFile'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />

       <Signature v-if="field.type === 'Signature'"
        :FormKey="tassililisting.urlCustomValidation" :cle="key" />

          </template>
        </div>

        <LoadAction/>

        <div class="max-w-[560px] mt-[10px] flex gap-[5px]">
              <button  v-if="(tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizardCurrent'] == tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizard'].wizardCount) ||
                tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizard'].wizardStop.includes(tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizardCurrent'])"
            
            class="bg-[blue] w-[100px] text-white p-[9px] rounded-[2px]" type="submit">
              Save
            </button>

            <button  v-if="(tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizardCurrent'] != 1)" @click="reculer()"
            class="bg-black w-[100px] text-white p-[9px] rounded-[2px] border border-white" type="button">
              Previous
            </button>

            <button v-if="(tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizardCurrent'] != tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizard'].wizardCount)"
            class="bg-black w-[100px] text-white p-[9px] rounded-[2px] border border-white" type="button"
            @click="submit('next')">
              Next
            </button>
            
          
          </div>



        </form>
    </div>
</template>

<script setup>
import {TassiliInput}    from '@/Vendor/TassiliLibs/stores/tassiliInput'
import InputText from '../Inputs/InputText.vue';
import Textarea from '../Inputs/Textarea.vue';
import InputNumber from '../Inputs/InputNumber.vue';
import Password from '../Inputs/Password.vue';
import InputSelect from '../Inputs/InputSelect.vue';
import InputDate from '../Inputs/InputDate.vue';
import InputRadio from '../Inputs/InputRadio.vue';
import Checkbox from '../Inputs/Checkbox.vue';
import CheckboxList from '../Inputs/CheckboxList.vue';
import RichEditor from '../Inputs/RichEditor.vue';
import InputFileEdit from '../Inputs/InputFileEdit.vue';
import MultipleFileEdit from '../Inputs/MultipleFileEdit.vue';
import Signature from '../Inputs/Signature.vue';
import Repeteur from '../Inputs/Repeteur.vue';
import { TassiliListing } from '@/Vendor/TassiliLibs/stores/tassiliListing'
import WizardStep from './WizardStep.vue';
import { usePage } from '@inertiajs/vue3'
import { router } from '@inertiajs/vue3';
import LoadAction from '../LoadAction.vue';
import { Notyf } from 'notyf';
import 'notyf/notyf.min.css';
import { computed } from "vue";

const page = usePage()
const tassiliInput = TassiliInput();
const tassililisting = TassiliListing();
tassiliInput.isAnimated = 'off'

const smCols = computed(() =>
 tassiliInput.tassiliFormList?.[tassililisting?.urlCustomValidation]?.info?.grid?.sm || 1
);
const mdCols = computed(() =>
 tassiliInput.tassiliFormList?.[tassililisting?.urlCustomValidation]?.info?.grid?.md || 1
);
const lgCols = computed(() =>
 tassiliInput.tassiliFormList?.[tassililisting?.urlCustomValidation]?.info?.grid?.lg || 1
);
const xlCols = computed(() =>
 tassiliInput.tassiliFormList?.[tassililisting?.urlCustomValidation]?.info?.grid?.xl || 1
);


function aftersave() {
  const notyf = new Notyf({ position: { x: 'right', y: 'top' } });
  notyf.success('Record created');
  tassililisting.customActionModal = false; 
}

function reculer() {
  tassiliInput.isAnimated = 'off'
  tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizardCurrent'] -= 1 
}


function nextValidate() {
  tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizardCurrent'] += 1 
}


  function cleanQuillContent(html) {
  if (typeof html !== 'string') return html;
  return html.replace(/<p>\s*<\/p>/g, '').replace(/<p><br><\/p>/g, '').trim();
}



function checkNullable() {
  let temoin = 0;

  Object.keys(tassiliInput.form[tassililisting.urlCustomValidation]).forEach((champ) => {

   if (tassiliInput.form[tassililisting.urlCustomValidation][champ]['type'] === 'MultipleFile') {
        if (tassiliInput.form[tassililisting.urlCustomValidation][champ]['options']['existingFiles'].length  === 0 && 
          tassiliInput.form[tassililisting.urlCustomValidation][champ]['options']['tempUrlTabs'].length === 0 &&
      tassiliInput.form[tassililisting.urlCustomValidation][champ]['options']['nullable'] === 'yes' && 
      tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizardCurrent'].includes(champ)) {
         temoin++;
           }
    }
 
  });

  return temoin;
}




function insert(action) {
tassiliInput.isAnimated = 'on'
const temoin = checkNullable();

if (temoin > 0) {
  const notyf = new Notyf({ position: { x: 'right', y: 'top' } });
  notyf.error(`${temoin} fields(s) multiple required are missing(s).`);
  tassiliInput.isAnimated = 'off'
  return;
}

const formData = new FormData();

 if (action == 'next') {
    formData.append('tassiliSaveActive', 'no');
  }
  if (action != 'next') {
    formData.append('tassiliSaveActive', 'yes');
  }
  
  formData.append('tassiliWizardStep',tassiliInput.tassiliFormList[tassililisting.urlCustomValidation]['info']['wizardCurrent']);
  
  formData.append(
    'urlValidationurlValidationurlValidationTassili17485RRY4R4RD9448RK48K4RFRFIRU',
    tassililisting.urlCustomValidation
  );

  formData.append('id', tassililisting.recordAction['id']);

  Object.keys(tassiliInput.form[tassililisting.urlCustomValidation]).forEach((key) => {

const tab1 = ['MultipleFile']
    if (tab1.includes(tassiliInput.form[tassililisting.urlCustomValidation][key]['type'])) {
    if(!tassiliInput.form[tassililisting.urlCustomValidation][key]['value'] || tassiliInput.form[tassililisting.urlCustomValidation][key]['value'].length === 0) {
      formData.append(key, '');
    }
    else if (Array.isArray(tassiliInput.form[tassililisting.urlCustomValidation][key]['value'])) {
      tassiliInput.form[tassililisting.urlCustomValidation][key]['value'].forEach((file, index) => {
        formData.append(`${key}[]`, file);
      });
    }
 

     const  temp = tassiliInput.form[tassililisting.urlCustomValidation][key]['options']['existingFiles'] || '[]';
     const index = key + '_newtab'
      formData.append(index, JSON.stringify(temp));

    } 


 const tab2 = ['File'];
    if(tab2.includes(tassiliInput.form[tassililisting.urlCustomValidation][key]['type'])) {
      formData.append(key , tassiliInput.form[tassililisting.urlCustomValidation][key]['value']);
    }


const tab3 = ['Text', 'Date', 'Hidden', 'Select', 'Number', 'Radio', 'Checkbox', 'CheckboxList', 'Password', 'Textarea','Signature'];
  if (tab3.includes(tassiliInput.form[tassililisting.urlCustomValidation][key]['type'])) {
    formData.append(  key , tassiliInput.form[tassililisting.urlCustomValidation][key]['value']);
    console.log(tassiliInput.form[tassililisting.urlCustomValidation][key]['value'])
  }


  const tab4 = ['Quill'];
    if(tab4.includes(tassiliInput.form[tassililisting.urlCustomValidation][key]['type'])) {
      formData.append(key, cleanQuillContent(tassiliInput.form[tassililisting.urlCustomValidation][key]['value'] || ''));
    }



if (tassiliInput.form[tassililisting.urlCustomValidation][key]['type'] === 'Repeater' ) {

   tassiliInput.form[tassililisting.urlCustomValidation][key]['value'].forEach((item, i) => {
    Object.entries(item).forEach(([subKey, subValue]) => {

       if(tassiliInput.form[tassililisting.urlCustomValidation][key]['fields'][subKey]['type'] === 'Quill') {
          subValue  = cleanQuillContent(subValue || '')
      }

      formData.append(`${key}[${i}][${subKey}]`, subValue);

    });
  });


}






});
   



router.post(tassililisting.urlCustomValidation, formData, {
    forceFormData: true,
    onError: (errors) => {
      tassiliInput.isAnimated = 'off'
      tassiliInput.setError(tassililisting.urlCustomValidation ,errors);
      console.error('Validation Errors:', tassiliInput.errors);
    },
    onSuccess: () => {
      if (action === 'save') {
        tassiliInput.isAnimated = 'off'
        aftersave();
      } 
     else if (action === 'next') {
      tassiliInput.isAnimated = 'off'
       nextValidate();
       tassiliInput.resetError();
      }
    }
  });


}



function submit(action) {
   insert(action);
  }




</script>

<style lang="css" scoped>

 .conteneurForm {
    display: grid;
    grid-template-columns: repeat(v-bind(smCols), 1fr);
    gap: 10px;
  }

@media (min-width: 640px) { 
  .conteneurForm {
    display: grid;
    grid-template-columns: repeat(v-bind(mdCols), 1fr);
  }
}

@media (min-width: 768px) { 
  .conteneurForm {
    display: grid;
    grid-template-columns: repeat(v-bind(lgCols), 1fr);
  }
}

@media (min-width: 1024px) { 
  .conteneurForm {
   display: grid;
   grid-template-columns: repeat(v-bind(xlCols), 1fr);
  
  }
}
</style>